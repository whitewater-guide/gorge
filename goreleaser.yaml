builds:
  - main: ./cli/main.go
    binary: gorge-server
    goos:
      - linux
    goarch:
      - amd64
      # - arm64
    flags:
      - -trimpath
    ldflags:
      - -s -w -X github.com/{{ .Env.REPO_NAME }}/version.Version={{ .Version }}
    tags:
      - sqlite_omit_load_extension
      - netgo
    hooks:
      post:
        - cmd: mkdir -p build
        - cmd: "ldd {{ .Path }} | tr -s '[:blank:]' '\n' | grep ^/ | xargs -I % install -D % build/%"
          output: true
        - cmd: ls -la build
          output: true

dockers:
  - id: amd64
    goos: linux
    goarch: amd64
    extra_files:
      - timezone.data
      - build
    image_templates:
      - "ghcr.io/{{ .Env.REPO_NAME }}:latest"
      - "ghcr.io/{{ .Env.REPO_NAME }}:{{ .Version }}"
  # - id: arm64
  #   goos: linux
  #   goarch: arm64
  #   extra_files:
  #     - timezone.data
  #   image_templates:
  #     - "ghcr.io/{{ .Env.REPO_NAME }}:latest"
  #     - "ghcr.io/{{ .Env.REPO_NAME }}:{{ .Version }}"
