name: Release
on:
  push:
  pull_request:
    branches:
      - master
env:
  REGISTRY: ghcr.io
  CI: true
jobs:
  build:
    name: Build
    # it's important to use this version of ubuntu, because it matches development docker image and has correct veriosn of libproj
    runs-on: ubuntu-22.04
    env:
      # beta branch is used for prereleases, as described in https://semantic-release.gitbook.io/semantic-release/usage/configuration#branches
      PUBLISH_RELEASE: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/beta') }}
    steps:
      - name: Check out
        uses: actions/checkout@v3

      - name: Install libproj
        run: |
          sudo apt-get install -y libproj-dev

      - name: Setup go
        uses: actions/setup-go@v4
        with:
          go-version-file: "go.mod"

      - name: Install GoReleaser
        uses: goreleaser/goreleaser-action@v4
        with:
          install-only: true

      - name: Restore cached timezone data
        id: cache-tz-restore
        uses: actions/cache/restore@v3
        with:
          path: timezone.data
          key: ${{ runner.os }}-tz-2023b

      - name: Verify and make typescript definitions
        run: |
          make test
          make lint
          make typescript

      - name: Save timezone data cache
        id: cache-tz-save
        uses: actions/cache/save@v3
        with:
          path: timezone.data
          key: ${{ steps.cache-tz-restore.outputs.cache-primary-key }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Semantic release
        uses: cycjimmy/semantic-release-action@v3
        with:
          extra_plugins: |
            @semantic-release/git
            @semantic-release/exec
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
